<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <h:form id="clienteForm" prependId="false">
        <p:messages autoUpdate="true" closable="true"/>
        
        <!-- Toolbar -->
        <p:toolbar style="margin-bottom: 20px;">
            <p:toolbarGroup>
                <p:commandButton value="Nuevo Cliente" 
                               action="#{clienteBean.newCliente}" 
                               update="@(.cliente-dialog)"
                               oncomplete="PF('clienteDialog').show()"
                               process="@this"
                               icon="pi pi-plus"
                               styleClass="ui-button-success"/>
                               
                <p:commandButton value="Actualizar Lista" 
                               action="#{clienteBean.loadClientes}" 
                               update="@(.cliente-table)"
                               icon="pi pi-refresh"/>
            </p:toolbarGroup>
        </p:toolbar>
        
        <!-- Data Table -->
        <p:dataTable id="clienteTable" 
                     styleClass="cliente-table ui-datatable-striped"
                     value="#{clienteBean.clientes}" 
                     var="cliente"
                     rows="10"
                     paginator="true"
                     paginatorPosition="both"
                     emptyMessage="No hay clientes registrados">
            
            <p:column headerText="ID" sortBy="#{cliente.id}">
                <h:outputText value="#{cliente.id}"/>
            </p:column>
            
            <p:column headerText="Cédula" sortBy="#{cliente.cedula}" filterBy="#{cliente.cedula}">
                <h:outputText value="#{cliente.cedula}"/>
            </p:column>
            
            <p:column headerText="Nombre Completo" sortBy="#{cliente.nombreCompleto}" filterBy="#{cliente.nombreCompleto}">
                <h:outputText value="#{cliente.nombreCompleto}"/>
            </p:column>
            
            <p:column headerText="Estado Civil" sortBy="#{cliente.estadoCivil}">
                <h:outputText value="#{cliente.estadoCivil}"/>
            </p:column>
            
            <p:column headerText="Fecha Nacimiento" sortBy="#{cliente.fechaNacimiento}">
                <h:outputText value="#{cliente.fechaNacimiento}"/>
            </p:column>
            
            <p:column headerText="Crédito Activo">
                <p:tag value="SÍ" severity="danger" rendered="#{cliente.tieneCreditoActivo}"/>
                <p:tag value="NO" severity="success" rendered="#{!cliente.tieneCreditoActivo}"/>
            </p:column>
            
            <p:column headerText="Acciones" style="width: 120px">
                <p:commandButton icon="pi pi-pencil" 
                               action="#{clienteBean.editCliente(cliente)}"
                               update="@(.cliente-dialog)"
                               oncomplete="PF('clienteDialog').show()"
                               process="@this"
                               title="Editar"
                               styleClass="ui-button-warning"/>
                               
                <p:commandButton icon="pi pi-trash" 
                               action="#{clienteBean.deleteCliente(cliente)}"
                               update="@(.cliente-table)"
                               title="Eliminar"
                               styleClass="ui-button-danger"
                               style="margin-left: 5px;">
                    <p:confirm header="Confirmación" message="¿Está seguro de eliminar este cliente?" icon="pi pi-question-circle"/>
                </p:commandButton>
            </p:column>
        </p:dataTable>
        
        <!-- Consultas Section -->
        <p:panel header="Consultas de Elegibilidad y Crédito" style="margin-top: 30px;">
            <div style="margin-bottom: 20px;">
                <p:outputLabel for="cedulaConsulta" value="Cédula del Cliente:" style="margin-right: 10px; font-weight: bold;"/>
                <p:inputText id="cedulaConsulta" 
                           value="#{clienteBean.cedulaConsulta}"
                           placeholder="Ingrese la cédula"
                           style="margin-right: 10px; width: 200px;"/>
                           
                <p:commandButton value="Verificar Elegibilidad" 
                               action="#{clienteBean.verificarElegibilidad}"
                               update="clienteForm"
                               icon="pi pi-check-circle"
                               styleClass="ui-button-info"
                               style="margin-right: 10px;"/>
                               
                <p:commandButton value="Calcular Monto Máximo" 
                               action="#{clienteBean.calcularMontoMaximo}"
                               update="clienteForm"
                               icon="pi pi-calculator"
                               styleClass="ui-button-info"/>
            </div>
            
            <!-- Resultado Elegibilidad -->
            <p:panel header="Resultado de Elegibilidad" rendered="#{clienteBean.showElegibilidad and clienteBean.elegibilidadResult != null}">
                <p:panelGrid columns="2" style="width: 100%;">
                    <p:outputLabel value="Es Cliente:"/>
                    <p:tag value="SÍ" severity="success" rendered="#{clienteBean.elegibilidadResult.esCliente}"/>
                    <p:tag value="NO" severity="danger" rendered="#{!clienteBean.elegibilidadResult.esCliente}"/>
                    
                    <p:outputLabel value="Cumple Edad y Estado Civil:"/>
                    <p:tag value="SÍ" severity="success" rendered="#{clienteBean.elegibilidadResult.cumpleEdadEstadoCivil}"/>
                    <p:tag value="NO" severity="danger" rendered="#{!clienteBean.elegibilidadResult.cumpleEdadEstadoCivil}"/>
                    
                    <p:outputLabel value="Tiene Depósito Último Mes:"/>
                    <p:tag value="SÍ" severity="success" rendered="#{clienteBean.elegibilidadResult.tieneDepositoUltimoMes}"/>
                    <p:tag value="NO" severity="danger" rendered="#{!clienteBean.elegibilidadResult.tieneDepositoUltimoMes}"/>
                    
                    <p:outputLabel value="No Tiene Crédito Activo:"/>
                    <p:tag value="SÍ" severity="success" rendered="#{clienteBean.elegibilidadResult.noTieneCreditoActivo}"/>
                    <p:tag value="NO" severity="danger" rendered="#{!clienteBean.elegibilidadResult.noTieneCreditoActivo}"/>
                    
                    <p:outputLabel value="Es Elegible:"/>
                    <p:tag value="ELEGIBLE" severity="success" rendered="#{clienteBean.elegibilidadResult.esElegible}"/>
                    <p:tag value="NO ELEGIBLE" severity="danger" rendered="#{!clienteBean.elegibilidadResult.esElegible}"/>
                    
                    <p:outputLabel value="Mensaje:"/>
                    <h:outputText value="#{clienteBean.elegibilidadResult.mensaje}" style="font-weight: bold;"/>
                </p:panelGrid>
            </p:panel>
            
            <!-- Resultado Monto Máximo -->
            <p:panel header="Resultado de Monto Máximo" rendered="#{clienteBean.showMontoMaximo and clienteBean.montoMaximoResult != null}">
                <p:panelGrid columns="2" style="width: 100%;">
                    <p:outputLabel value="Monto Máximo de Crédito:"/>
                    <h:outputText value="$#{clienteBean.montoMaximoResult.montoMaximoCredito}" style="font-weight: bold; font-size: 16px; color: #2196F3;">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                    
                    <p:outputLabel value="Promedio Depósitos:"/>
                    <h:outputText value="$#{clienteBean.montoMaximoResult.promedioDepositos}">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                    
                    <p:outputLabel value="Promedio Retiros:"/>
                    <h:outputText value="$#{clienteBean.montoMaximoResult.promedioRetiros}">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                    
                    <p:outputLabel value="Mensaje:"/>
                    <h:outputText value="#{clienteBean.montoMaximoResult.mensaje}" style="font-weight: bold;"/>
                </p:panelGrid>
            </p:panel>
        </p:panel>
    </h:form>
    
    <!-- Dialog for Add/Edit Client -->
    <p:dialog id="clienteDialogForm"
              styleClass="cliente-dialog"
              header="#{clienteBean.edit ? 'Editar Cliente' : 'Nuevo Cliente'}" 
              widgetVar="clienteDialog" 
              modal="true" 
              resizable="false"
              width="500"
              responsive="true"
              appendTo="@(body)">
        
        <h:form prependId="false">
            <p:messages autoUpdate="true" closable="true"/>
            
            <p:panelGrid columns="2" style="width: 100%;" columnClasses="ui-grid-col-3,ui-grid-col-9">
                <p:outputLabel for="cedula" value="Cédula:"/>
                <p:inputText id="cedula" 
                           value="#{clienteBean.clienteForm.cedula}"
                           required="true"
                           requiredMessage="La cédula es requerida"
                           maxlength="10"
                           placeholder="Ej: 1234567890"/>
                
                <p:outputLabel for="nombreCompleto" value="Nombre Completo:"/>
                <p:inputText id="nombreCompleto" 
                           value="#{clienteBean.clienteForm.nombreCompleto}"
                           required="true"
                           requiredMessage="El nombre completo es requerido"
                           placeholder="Ej: Juan Pérez"/>
                
                <p:outputLabel for="estadoCivil" value="Estado Civil:"/>
                <p:selectOneMenu id="estadoCivil" 
                               value="#{clienteBean.clienteForm.estadoCivil}"
                               required="true"
                               requiredMessage="El estado civil es requerido">
                    <f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true"/>
                    <f:selectItems value="#{clienteBean.estadosCiviles}" var="estado" 
                                 itemLabel="#{estado}" itemValue="#{estado}"/>
                </p:selectOneMenu>
                
                <p:outputLabel for="fechaNacimiento" value="Fecha Nacimiento:"/>
                <p:inputText id="fechaNacimiento" 
                          value="#{clienteBean.clienteForm.fechaNacimiento}"
                          placeholder="yyyy-MM-dd"
                          required="true"
                          requiredMessage="La fecha de nacimiento es requerida"/>
            </p:panelGrid>
            
            <div style="text-align: center; margin-top: 20px;">
                <p:commandButton value="Guardar" 
                               action="#{clienteBean.saveCliente}"
                               update="@(.cliente-dialog) @(.cliente-table)"
                               oncomplete="if (args.validationFailed || !args.saved) PF('clienteDialog').show(); else PF('clienteDialog').hide();"
                               icon="pi pi-check"
                               styleClass="ui-button-success"
                               style="margin-right: 10px;"/>
                               
                <p:commandButton value="Cancelar" 
                               action="#{clienteBean.cancelDialog}"
                               oncomplete="PF('clienteDialog').hide()"
                               icon="pi pi-times"
                               styleClass="ui-button-secondary"
                               immediate="true"/>
            </div>
        </h:form>
    </p:dialog>
    
    <!-- Confirmation Dialog -->
    <h:form prependId="false">
    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
        <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
        <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary" icon="pi pi-times"/>
    </p:confirmDialog>
    </h:form>

</ui:composition>