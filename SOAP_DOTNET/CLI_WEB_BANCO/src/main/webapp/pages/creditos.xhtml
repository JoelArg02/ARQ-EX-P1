<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <h:form id="creditoForm" prependId="false">
        <p:messages autoUpdate="true" closable="true"/>
        
        <!-- Toolbar -->
        <p:toolbar style="margin-bottom: 20px;">
            <p:toolbarGroup>
                <p:commandButton value="Aprobar Cr√©dito" 
                               action="#{creditoBean.newCredito}" 
                               update="@(.nuevo-credito-dialog)"
                               oncomplete="PF('nuevoDialog').show()"
                               icon="pi pi-plus"
                               styleClass="ui-button-success"/>
                               
                <p:commandButton value="Actualizar Lista" 
                               action="#{creditoBean.loadCreditos}" 
                               update="@(.credito-table)"
                               icon="pi pi-refresh"/>
            </p:toolbarGroup>
        </p:toolbar>
        
        <!-- Data Table -->
        <p:dataTable id="creditoTable" 
                     styleClass="credito-table ui-datatable-striped"
                     value="#{creditoBean.creditos}" 
                     var="credito"
                     rows="10"
                     paginator="true"
                     paginatorPosition="both"
                     emptyMessage="No hay cr√©ditos registrados">
            
            <p:column headerText="ID" sortBy="#{credito.id}">
                <h:outputText value="#{credito.id}"/>
            </p:column>
            
            <p:column headerText="Cliente" sortBy="#{credito.clienteBancoId}">
                <div>
                    <strong>#{creditoBean.getClienteNombre(credito.clienteBancoId)}</strong><br/>
                    <small>#{creditoBean.getClienteCedula(credito.clienteBancoId)}</small>
                </div>
            </p:column>
            
            <p:column headerText="Monto Aprobado" sortBy="#{credito.montoAprobado}">
                <h:outputText value="$#{credito.montoAprobado}" style="font-weight: bold; color: #2196F3; font-size: 16px;">
                    <f:convertNumber pattern="#,##0.00"/>
                </h:outputText>
            </p:column>
            
            <p:column headerText="Cuotas" sortBy="#{credito.numeroCuotas}">
                <p:tag value="#{credito.numeroCuotas} cuotas" severity="info"/>
            </p:column>
            
            <p:column headerText="Tasa Inter√©s" sortBy="#{credito.tasaInteres}">
                <h:outputText value="#{credito.tasaInteres * 100}%">
                    <f:convertNumber pattern="#0.00"/>
                </h:outputText>
            </p:column>
            
            <p:column headerText="Fecha Aprobaci√≥n" sortBy="#{credito.fechaAprobacion}">
                <h:outputText value="#{credito.fechaAprobacion}"/>
            </p:column>
            
            <p:column headerText="Estado">
                <p:tag value="ACTIVO" severity="success" rendered="#{credito.activo}"/>
                <p:tag value="INACTIVO" severity="danger" rendered="#{!credito.activo}"/>
            </p:column>
            
            <p:column headerText="Acciones" style="width: 120px">
                <p:commandButton icon="pi pi-table" 
                               action="#{creditoBean.verAmortizacion(credito)}"
                               update="@(.amortizacion-dialog)"
                               oncomplete="PF('amortizacionDialog').show()"
                               title="Ver Tabla de Amortizaci√≥n"
                               styleClass="ui-button-info"
                               style="margin-right: 5px;"/>
                               
                <p:commandButton icon="pi pi-trash" 
                               action="#{creditoBean.deleteCredito(credito)}"
                               update="@(.credito-table)"
                               title="Eliminar"
                               styleClass="ui-button-danger">
                    <p:confirm header="Confirmaci√≥n" message="¬øEst√° seguro de eliminar este cr√©dito?" icon="pi pi-question-circle"/>
                </p:commandButton>
            </p:column>
        </p:dataTable>
    </h:form>
    
    <!-- Dialog for New Credit -->
    <p:dialog id="nuevoDialogForm"
              styleClass="nuevo-credito-dialog"
              header="Aprobar Nuevo Cr√©dito" 
              widgetVar="nuevoDialog" 
              modal="true" 
              resizable="false"
              width="500"
              responsive="true"
              appendTo="@(body)">
        
        <h:form prependId="false">
            <p:messages autoUpdate="true" closable="true"/>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                <h4 style="margin: 0; color: #1976D2;">üí° Informaci√≥n Importante</h4>
                <p style="margin: 10px 0 0 0; color: #555;">
                    Antes de aprobar un cr√©dito, verifique la elegibilidad del cliente en la secci√≥n de Clientes.
                </p>
            </div>
            
            <p:panelGrid columns="2" style="width: 100%;" columnClasses="ui-grid-col-3,ui-grid-col-9">
                <p:outputLabel for="cedulaCliente" value="C√©dula del Cliente:"/>
                <p:inputText id="cedulaCliente" 
                           value="#{creditoBean.cedulaCliente}"
                           required="true"
                           requiredMessage="La c√©dula del cliente es requerida"
                           maxlength="10"
                           placeholder="Ej: 1234567890"/>
                
                <p:outputLabel for="montoSolicitado" value="Monto Solicitado:"/>
                <p:inputNumber id="montoSolicitado" 
                             value="#{creditoBean.montoSolicitado}"
                             required="true"
                             requiredMessage="El monto solicitado es requerido"
                             minValue="100"
                             maxValue="100000"
                             decimalPlaces="2"
                             symbol="$ "
                             thousandSeparator=","
                             decimalSeparator="."/>
                
                <p:outputLabel for="numeroCuotas" value="N√∫mero de Cuotas:"/>
                <p:selectOneMenu id="numeroCuotas" 
                               value="#{creditoBean.numeroCuotas}"
                               required="true"
                               requiredMessage="El n√∫mero de cuotas es requerido">
                    <f:selectItems value="#{creditoBean.numeroCuotasOpciones}" var="cuota" 
                                 itemLabel="#{cuota} cuotas" itemValue="#{cuota}"/>
                </p:selectOneMenu>
            </p:panelGrid>
            
            <div style="margin-top: 20px; padding: 15px; background-color: #fff3e0; border-radius: 8px;">
                <h5 style="margin: 0 0 10px 0; color: #f57c00;">üìä Informaci√≥n del Cr√©dito</h5>
                <p style="margin: 5px 0; color: #666;">
                    <strong>Tasa de Inter√©s:</strong> 16% anual
                </p>
                <p style="margin: 5px 0; color: #666;">
                    <strong>Tipo de Cr√©dito:</strong> Personal
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p:commandButton value="Aprobar Cr√©dito" 
                               action="#{creditoBean.saveCredito}"
                               update="@(.nuevo-credito-dialog) @(.credito-table)"
                               oncomplete="if (args.validationFailed || !args.saved) PF('nuevoDialog').show(); else PF('nuevoDialog').hide();"
                               icon="pi pi-check"
                               styleClass="ui-button-success"
                               style="margin-right: 10px;"/>
                               
                <p:commandButton value="Cancelar" 
                               action="#{creditoBean.cancelNuevoDialog}"
                               oncomplete="PF('nuevoDialog').hide()"
                               icon="pi pi-times"
                               styleClass="ui-button-secondary"
                               immediate="true"/>
            </div>
        </h:form>
    </p:dialog>
    
    <!-- Dialog for Amortization Table -->
    <p:dialog id="amortizacionDialogForm"
              styleClass="amortizacion-dialog"
              header="Tabla de Amortizaci√≥n" 
              widgetVar="amortizacionDialog" 
              modal="true" 
              resizable="true"
              width="900"
              height="600"
              responsive="true"
              appendTo="@(body)">
        
        <h:form prependId="false">
            <div style="margin-bottom: 20px;">
                <h:panelGrid columns="2" style="width: 100%;" rendered="#{creditoBean.creditoAmortizacion != null}">
                    <h:panelGroup style="text-align: left;">
                        <h4 style="margin: 0; color: #333;">Informaci√≥n del Cr√©dito</h4>
                        <p><strong>Cliente:</strong> #{creditoBean.getClienteNombre(creditoBean.creditoAmortizacion.clienteBancoId)}</p>
                        <p><strong>Monto:</strong> $<h:outputText value="#{creditoBean.creditoAmortizacion.montoAprobado}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText></p>
                        <p><strong>Cuotas:</strong> #{creditoBean.creditoAmortizacion.numeroCuotas}</p>
                        <p><strong>Tasa:</strong> #{creditoBean.creditoAmortizacion.tasaInteres * 100}%</p>
                    </h:panelGroup>
                    
                    <h:panelGroup style="text-align: right;">
                        <h4 style="margin: 0; color: #333;">Resumen de Pagos</h4>
                        <p><strong>Total Capital:</strong> $<h:outputText value="#{creditoBean.totalCapital}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText></p>
                        <p><strong>Total Intereses:</strong> $<h:outputText value="#{creditoBean.totalIntereses}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText></p>
                        <p><strong>Total a Pagar:</strong> $<h:outputText value="#{creditoBean.totalPagos}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText></p>
                    </h:panelGroup>
                </h:panelGrid>
            </div>
            
            <p:dataTable value="#{creditoBean.amortizaciones}" 
                         var="amort"
                         paginator="true"
                         rows="10"
                         emptyMessage="No hay datos de amortizaci√≥n"
                         styleClass="ui-datatable-striped">
                
                <p:column headerText="Cuota" style="width: 80px; text-align: center;">
                    <h:outputText value="#{amort.numeroCuota}" style="font-weight: bold;"/>
                </p:column>
                
                <p:column headerText="Valor Cuota">
                    <h:outputText value="$#{amort.montoCuota}" style="font-weight: bold; color: #2196F3;">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                </p:column>
                
                <p:column headerText="Capital">
                    <h:outputText value="$#{amort.capital}">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                </p:column>
                
                <p:column headerText="Inter√©s">
                    <h:outputText value="$#{amort.interes}">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                </p:column>
                
                <p:column headerText="Saldo Pendiente">
                    <h:outputText value="$#{amort.saldoPendiente}">
                        <f:convertNumber pattern="#,##0.00"/>
                    </h:outputText>
                </p:column>
            </p:dataTable>
            
            <div style="text-align: center; margin-top: 20px;">
                <p:commandButton value="Cerrar" 
                               action="#{creditoBean.cancelAmortizacionDialog}"
                               oncomplete="PF('amortizacionDialog').hide()"
                               icon="pi pi-times"
                               styleClass="ui-button-secondary"/>
            </div>
        </h:form>
    </p:dialog>
    
    <!-- Confirmation Dialog -->
    <h:form>
        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
            <p:commandButton value="S√≠" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary" icon="pi pi-times"/>
        </p:confirmDialog>
    </h:form>

</ui:composition>