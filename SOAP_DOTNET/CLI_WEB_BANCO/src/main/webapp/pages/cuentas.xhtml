<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <h:form id="cuentaForm" prependId="false">
        <p:messages autoUpdate="true" closable="true"/>
        
        <!-- Toolbar -->
        <p:toolbar style="margin-bottom: 20px;">
            <p:toolbarGroup>
                <p:commandButton value="Nueva Cuenta" 
                               action="#{cuentaBean.newCuenta}" 
                               update="@(.cuenta-dialog)"
                               oncomplete="PF('cuentaDialog').show()"
                               icon="pi pi-plus"
                               styleClass="ui-button-success"/>
                               
                <p:commandButton value="Actualizar Lista" 
                               action="#{cuentaBean.loadCuentas}" 
                               update="@(.cuenta-table)"
                               icon="pi pi-refresh"/>
            </p:toolbarGroup>
        </p:toolbar>
        
        <!-- Data Table -->
        <p:dataTable id="cuentaTable" 
                     styleClass="cuenta-table ui-datatable-striped"
                     value="#{cuentaBean.cuentas}" 
                     var="cuenta"
                     rows="10"
                     paginator="true"
                     paginatorPosition="both"
                     emptyMessage="No hay cuentas registradas">
            
            <p:column headerText="ID" sortBy="#{cuenta.id}">
                <h:outputText value="#{cuenta.id}"/>
            </p:column>
            
            <p:column headerText="Cliente" sortBy="#{cuenta.clienteBancoId}">
                <h:outputText value="#{cuentaBean.getClienteNombre(cuenta.clienteBancoId)}"/>
            </p:column>
            
            <p:column headerText="Número Cuenta" sortBy="#{cuenta.numeroCuenta}" filterBy="#{cuenta.numeroCuenta}">
                <h:outputText value="#{cuenta.numeroCuenta}"/>
            </p:column>
            
            <p:column headerText="Tipo Cuenta" sortBy="#{cuenta.tipoCuenta}">
                <p:tag value="#{cuenta.tipoCuenta}" severity="#{cuenta.tipoCuenta == 'Ahorros' ? 'success' : 'info'}"/>
            </p:column>
            
            <p:column headerText="Saldo" sortBy="#{cuenta.saldo}">
                <h:outputText value="$#{cuenta.saldo}" style="font-weight: bold; color: #{cuenta.saldo >= 0 ? '#4CAF50' : '#F44336'};">
                    <f:convertNumber pattern="#,##0.00"/>
                </h:outputText>
            </p:column>
            
            <p:column headerText="Acciones" style="width: 160px">
                <p:commandButton icon="pi pi-dollar" 
                               action="#{cuentaBean.openOperacionDialog(cuenta)}"
                               update="@(.operacion-dialog)"
                               oncomplete="PF('operacionDialog').show()"
                               title="Operaciones Bancarias"
                               styleClass="ui-button-info"
                               style="margin-right: 5px;"/>
                               
                <p:commandButton icon="pi pi-pencil" 
                               action="#{cuentaBean.editCuenta(cuenta)}"
                               update="@(.cuenta-dialog)"
                               oncomplete="PF('cuentaDialog').show()"
                               title="Editar"
                               styleClass="ui-button-warning"
                               style="margin-right: 5px;"/>
                               
                <p:commandButton icon="pi pi-trash" 
                               action="#{cuentaBean.deleteCuenta(cuenta)}"
                               update="@(.cuenta-table)"
                               title="Eliminar"
                               styleClass="ui-button-danger">
                    <p:confirm header="Confirmación" message="¿Está seguro de eliminar esta cuenta?" icon="pi pi-question-circle"/>
                </p:commandButton>
            </p:column>
        </p:dataTable>
    </h:form>
    
    <!-- Dialog for Add/Edit Account -->
    <p:dialog id="cuentaDialogForm"
              styleClass="cuenta-dialog"
              header="#{cuentaBean.edit ? 'Editar Cuenta' : 'Nueva Cuenta'}" 
              widgetVar="cuentaDialog" 
              modal="true" 
              resizable="false"
              width="500"
              responsive="true"
              appendTo="@(body)">
        
        <h:form prependId="false">
            <p:messages autoUpdate="true" closable="true"/>
            
            <p:panelGrid columns="2" style="width: 100%;" columnClasses="ui-grid-col-3,ui-grid-col-9">
                <p:outputLabel for="clienteId" value="Cliente:"/>
                <p:selectOneMenu id="clienteId" 
                               value="#{cuentaBean.cuentaForm.clienteBancoId}"
                               required="true"
                               requiredMessage="El cliente es requerido">
                    <f:selectItem itemLabel="Seleccione un cliente..." itemValue="" noSelectionOption="true"/>
                    <f:selectItems value="#{cuentaBean.clientes}" var="cliente" 
                                 itemLabel="#{cliente.nombreCompleto} (#{cliente.cedula})" 
                                 itemValue="#{cliente.id}"/>
                </p:selectOneMenu>
                
                <p:outputLabel for="numeroCuenta" value="Número de Cuenta:"/>
                <p:inputText id="numeroCuenta" 
                           value="#{cuentaBean.cuentaForm.numeroCuenta}"
                           required="true"
                           requiredMessage="El número de cuenta es requerido"
                           maxlength="20"
                           placeholder="Ej: 001234567890"/>
                
                <p:outputLabel for="tipoCuenta" value="Tipo de Cuenta:"/>
                <p:selectOneMenu id="tipoCuenta" 
                               value="#{cuentaBean.cuentaForm.tipoCuenta}"
                               required="true"
                               requiredMessage="El tipo de cuenta es requerido">
                    <f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true"/>
                    <f:selectItems value="#{cuentaBean.tiposCuenta}" var="tipo" 
                                 itemLabel="#{tipo}" itemValue="#{tipo}"/>
                </p:selectOneMenu>
                
                <p:outputLabel for="saldo" value="Saldo Inicial:"/>
                <p:inputNumber id="saldo" 
                             value="#{cuentaBean.cuentaForm.saldo}"
                             required="true"
                             requiredMessage="El saldo inicial es requerido"
                             minValue="0"
                             decimalPlaces="2"
                             symbol="$ "
                             thousandSeparator=","
                             decimalSeparator="."/>
            </p:panelGrid>
            
            <div style="text-align: center; margin-top: 20px;">
                <p:commandButton value="Guardar" 
                               action="#{cuentaBean.saveCuenta}"
                               update="@(.cuenta-dialog) @(.cuenta-table)"
                               oncomplete="if (args.validationFailed || !args.saved) PF('cuentaDialog').show(); else PF('cuentaDialog').hide();"
                               icon="pi pi-check"
                               styleClass="ui-button-success"
                               style="margin-right: 10px;"/>
                               
                <p:commandButton value="Cancelar" 
                               action="#{cuentaBean.cancelDialog}"
                               oncomplete="PF('cuentaDialog').hide()"
                               icon="pi pi-times"
                               styleClass="ui-button-secondary"
                               immediate="true"/>
            </div>
        </h:form>
    </p:dialog>
    
    <!-- Dialog for Banking Operations -->
    <p:dialog id="operacionDialogForm"
              styleClass="operacion-dialog"
              header="Operaciones Bancarias" 
              widgetVar="operacionDialog" 
              modal="true" 
              resizable="false"
              width="500"
              responsive="true"
              appendTo="@(body)">
        
        <h:form prependId="false">
            <p:messages id="operacionMessages" closable="true" showDetail="true"/>
            
            <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                <h4 style="margin: 0; color: #333;">Información de la Cuenta</h4>
                <p style="margin: 5px 0;"><strong>Número:</strong> #{cuentaBean.cuentaOperacion.numeroCuenta}</p>
                <p style="margin: 5px 0;"><strong>Tipo:</strong> #{cuentaBean.cuentaOperacion.tipoCuenta}</p>
                <p style="margin: 5px 0;"><strong>Saldo Actual:</strong> 
                    <span style="font-weight: bold; font-size: 18px; color: #{cuentaBean.cuentaOperacion.saldo >= 0 ? '#4CAF50' : '#F44336'};">
                        $<h:outputText value="#{cuentaBean.cuentaOperacion.saldo}">
                            <f:convertNumber pattern="#,##0.00"/>
                        </h:outputText>
                    </span>
                </p>
            </div>
            
            <p:panelGrid columns="2" style="width: 100%;" columnClasses="ui-grid-col-3,ui-grid-col-9">
                <p:outputLabel for="tipoMovimiento" value="Tipo de Operación:"/>
                <p:selectOneMenu id="tipoMovimiento" 
                               value="#{cuentaBean.movimientoForm.tipoMovimiento}"
                               required="true"
                               requiredMessage="El tipo de operación es requerido">
                    <f:selectItem itemLabel="Seleccione..." itemValue="" noSelectionOption="true"/>
                    <f:selectItems value="#{cuentaBean.tiposMovimiento}" var="tipo" 
                                 itemLabel="#{tipo}" itemValue="#{tipo}"/>
                </p:selectOneMenu>
                
                <p:outputLabel for="monto" value="Monto:"/>
                <p:inputNumber id="monto" 
                             value="#{cuentaBean.movimientoForm.monto}"
                             required="true"
                             requiredMessage="El monto es requerido"
                             minValue="0.01"
                             decimalPlaces="2"
                             symbol="$ "
                             thousandSeparator=","
                             decimalSeparator="."/>
                
                <p:outputLabel for="descripcion" value="Descripción:"/>
                <p:inputTextarea id="descripcion" 
                               value="#{cuentaBean.movimientoForm.descripcion}"
                               rows="3"
                               cols="30"
                               placeholder="Descripción de la operación (opcional)"/>
            </p:panelGrid>
            
            <div style="text-align: center; margin-top: 20px;">
                <p:commandButton value="Realizar Operación" 
                               action="#{cuentaBean.realizarOperacion}"
                               update="operacionMessages @(.cuenta-table)"
                               oncomplete="if (args.validationFailed || !args.saved) PF('operacionDialog').show(); else PF('operacionDialog').hide();"
                               icon="pi pi-check"
                               styleClass="ui-button-success"
                               style="margin-right: 10px;"/>
                               
                <p:commandButton value="Cancelar" 
                               action="#{cuentaBean.cancelOperacionDialog}"
                               oncomplete="PF('operacionDialog').hide()"
                               icon="pi pi-times"
                               styleClass="ui-button-secondary"
                               immediate="true"/>
            </div>
        </h:form>
    </p:dialog>
    
    <!-- Confirmation Dialog -->
    <h:form>
        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
            <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary" icon="pi pi-times"/>
        </p:confirmDialog>
    </h:form>

</ui:composition>